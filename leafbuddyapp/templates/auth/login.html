{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Login | LeafBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="icon"
      href="https://img.icons8.com/ios-filled/50/23d58c/leaf.png"
      type="image/png"
    />
    <style>
      .input-container {
        position: relative;
        margin-bottom: 1.5rem;
      }

      .input-container input {
        padding: 0.75rem 1rem;
        font-size: 1rem;
        line-height: 1.5rem;
        border: 1px solid #ccc;
        border-radius: 0.375rem;
        width: 100%;
        background-color: #fff;
        box-sizing: border-box;
      }

      .input-container label {
        position: absolute;
        left: 1rem;
        top: 0.8rem;
        font-size: 1rem;
        color: #6b7280;
        background-color: #fff;
        padding-left: 0.25rem;
        padding-right: 0.25rem;
        transition: all 0.2s ease-out;
        pointer-events: none;
      }

      .input-container input:focus + label,
      .input-container input.has-value + label {
        top: -0.5rem;
        font-size: 0.75rem;
        color: #34d399;
      }

      .input-container input:focus {
        outline: none;
        border-color: #34d399;
        box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.3);
      }

      button {
        height: 2.5rem;
      }

      .google-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        background-color: white;
        border: 1px solid #ccc;
        color: #333;
        transition: background-color 0.3s ease;
      }

      .google-btn:hover {
        background-color: #f1f1f1;
      }

      .google-btn img {
        width: 1.25rem;
        height: 1.25rem;
      }

      /* Spinner and overlay styles */
      .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4); 
        display: flex;
        justify-content: center;
        align-items: center;
        visibility: hidden; 
        z-index: 50; 
      }

      .spinner {
        border: 8px solid #f3f3f3; 
        border-top: 8px solid #34d399; 
        border-radius: 50%;
        width: 60px; 
        height: 60px; 
        animation: spin 1.5s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Navbar -->
    <div class="absolute top-0 left-0 w-full">
      {% include 'auth/nav.html' %}
    </div>

    <!-- Container -->
    <div class="flex items-center justify-center min-h-screen pt-20">
      <div class="p-8 rounded-xl w-full max-w-md">
        <div id="spinnerOverlay" class="spinner-overlay">
          <div class="spinner"></div>
        </div>

        <div class="flex flex-col items-center mb-6">
          <h1 class="text-2xl font-bold text-green-400 mt-2">Welcome Back</h1>
        </div>
        <form id="loginForm" method="POST">
          {% csrf_token %}
          <div class="input-container">
            <input
              type="email"
              name="email"
              id="email"
              required
              autocomplete="off"
              value="{{ form_data.email }}"
              class="focus:outline-none focus:ring-2 focus:ring-green-400 {% if form_data.email %}has-value{% endif %}"
              placeholder=" "
            />
            <label for="email">Email</label>
            {% if errors.email %}
            <p class="text-red-500 text-sm mt-1">{{ errors.email }}</p>
            {% endif %}
          </div>
          <div class="input-container">
            <input
              type="password"
              name="password"
              id="password"
              required
              class="focus:outline-none focus:ring-2 focus:ring-green-400"
              placeholder=" "
            />
            {% if errors.password %}
            <p class="text-red-500 text-sm mt-1">{{ errors.password }}</p>
            {% endif %}
            <label for="password">Password</label>
          </div>

          <div class="text-right mb-4">
            <a
              href="{% url 'forgot_password' %}"
              class="text-sm text-green-500 hover:underline"
            >
              Forgot password?
            </a>
          </div>

          <button
            type="submit"
            class="w-full bg-green-500 text-white font-semibold py-6 rounded hover:bg-green-600 transition duration-300 flex items-center justify-center"
          >
            Sign In
          </button>

          <div class="flex items-center my-4">
            <hr class="flex-grow border-gray-300" />
            <span class="mx-2 text-gray-500 text-sm">OR</span>
            <hr class="flex-grow border-gray-300" />
          </div>

          <a href="{{ google_auth_url }}" class="google-btn">
            <img src="{% static 'images/google.png' %}" alt="Google Icon" />
            Sign in with Google
          </a>
        </form>
        <p class="mt-4 text-center text-sm text-gray-600">
          Donâ€™t have an account?
          <a
            href="{% url 'signup' %}"
            class="text-green-600 font-medium hover:underline"
            >Sign Up</a
          >
        </p>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        const spinnerOverlay = document.getElementById("spinnerOverlay");

        // Function to handle form input changes
        const inputs = document.querySelectorAll(".input-container input");

        inputs.forEach((input) => {
          // Add 'has-value' class when input is filled
          input.addEventListener("input", function () {
            if (input.value.trim() !== "") {
              input.classList.add("has-value");
            } else {
              input.classList.remove("has-value");
            }
          });

          // Check if the input already has a value on page load
          if (input.value.trim() !== "") {
            input.classList.add("has-value");
          }
        });

        loginForm.addEventListener("submit", function (event) {
          event.preventDefault();

          spinnerOverlay.style.visibility = "visible";

          setTimeout(function () {
            loginForm.submit(); 
          }, 1500); 
        });

        // Check if access_token exists in the URL fragment
        if (window.location.hash.includes("access_token")) {
          const params = new URLSearchParams(window.location.hash.slice(1));
          const accessToken = params.get("access_token");
          if (accessToken) {
            window.location.href = `/auth/callback/?access_token=${accessToken}`;
          }
        }
      });
    </script>
  </body>
</html>
