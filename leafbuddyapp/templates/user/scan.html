{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scan - LeafBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="icon"
      href="https://img.icons8.com/ios-filled/50/23d58c/leaf.png"
      type="image/png"
    />
  </head>
  <body class="font-sans">
    {% include 'partials/navbar.html' %}

    <section class="min-h-screen py-24 px-6">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-5xl font-extrabold text-green-400 mb-6">Leaf Scan</h1>
        <p class="text-md font-medium text-gray-700 mb-12">
          Upload or capture a leaf image and let LeafBuddy's AI identify plant
          diseases instantly.
        </p>

        <form
          action="{% url 'scan' %}"
          method="POST"
          enctype="multipart/form-data"
          class="rounded-xl max-w-lg mx-auto space-y-8"
        >
          {% csrf_token %}

          <!-- CROP SELECT -->
          <div>
            <select
              name="crop_type"
              id="crop_type"
              required
              class="w-full p-3 border border-green-400 rounded-lg bg-green-50 focus:ring-2 focus:ring-green-400"
            >
              <option value="">Choose Crop Type</option>
              {% for crop in crops %}
              <option value="{{ crop.id }}">{{ crop.name|capfirst }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- IMAGE PREVIEW -->
          <div>
            <div class="flex justify-center space-x-3 mt-4">
              <button
                type="button"
                onclick="openCamera()"
                class="flex items-center space-x-2 bg-green-500 hover:bg-green-600 text-white font-medium px-4 py-2 rounded-lg transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 7h4l2-3h6l2 3h4v12H3V7z"
                  />
                  <circle
                    cx="12"
                    cy="13"
                    r="3"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
                <span>Use Camera</span>
              </button>

              <button
                type="button"
                onclick="document.getElementById('leaf_image').click()"
                class="flex items-center space-x-2 bg-green-300 hover:bg-green-400 text-green-900 font-medium px-4 py-2 rounded-lg transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M4 12l8-8 8 8M12 4v12"
                  />
                </svg>
                <span>&nbsp;Upload&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
              </button>
            </div>

            <div
              class="relative w-full h-[22rem] flex justify-center mt-8 border-2 border-dashed border-green-300 rounded-xl p-6 bg-green-50"
            >
              <!-- Centered Text -->
              <h2 class="absolute top-4 text-lg font-bold text-gray-700">
                Preview
              </h2>

              <!-- Centered Image -->
              <img
                id="preview"
                src="{% static 'images/image_preview.png' %}"
                class="w-60 h-60 object-cover self-center"
                alt="Leaf preview"
              />
            </div>

            <input
              type="file"
              id="leaf_image"
              name="leaf_image"
              accept="image/*"
              class="hidden"
              onchange="handleFile(this.files[0])"
            />
          </div>

          <!-- SCAN BUTTON -->
          <div>
            <button
              type="submit"
              class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-green-700 transition duration-300 ease-in-out"
            >
              Scan Now
            </button>
          </div>
        </form>
      </div>
    </section>
    {% include 'partials/footer.html' %}
    <!-- CAMERA MODAL -->
    <div
      id="cameraModal"
      class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"
    >
      <div class="bg-white p-4 rounded-xl text-center">
        <!-- Video + Overlay Container -->
        <div class="relative inline-block">
          <!-- Camera Feed -->
          <video
            id="cameraPreview"
            autoplay
            playsinline
            class="w-80 rounded-lg"
          ></video>

          <!-- Prediction inside the camera frame -->
          <div
            id="predictionOverlay"
            class="absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-white bg-opacity-80 text-green-800 px-4 py-2 rounded-lg text-sm font-semibold shadow hidden flex items-center space-x-2"
          >
            <!-- Spinner -->
            <svg
              id="spinner"
              class="w-4 h-4 animate-spin text-green-800 hidden"
              fill="none"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>

            <!-- Text -->
            <span id="predictionText">Loading...</span>
          </div>
        </div>

        <div class="mt-3 flex justify-center space-x-3">
          <button
            onclick="capturePhoto()"
            class="bg-green-500 text-white px-4 py-2 rounded-lg"
          >
            Capture
          </button>
          <button
            onclick="closeCamera()"
            class="bg-red-500 text-white px-4 py-2 rounded-lg"
          >
            Close
          </button>
        </div>
      </div>
    </div>
    <!-- IMAGE UPLOAD/CAPTURE MODAL -->
    <div
      id="imageModal"
      class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"
      onclick="closeModal(event)"
    >
      <div
        class="bg-white p-4 rounded-xl text-center w-96 relative"
        onclick="event.stopPropagation()"
      >
        <!-- Close Button -->
        <button
          onclick="closeModal()"
          class="absolute top-1 right-1 text-black p-1 mb-4 rounded-full"
        >
          Ã—
        </button>

        <h2 class="text-lg font-bold text-gray-700 mt-4 mb-4">
          Please Upload or Capture an Image First!
        </h2>
        <p class="text-md text-gray-600 mb-6">
          You need to upload or capture a leaf image to proceed with the scan.
        </p>
        <div class="flex justify-center space-x-3">
          <button
            onclick="openCamera()"
            class="bg-green-500 text-white px-4 py-2 rounded-lg"
          >
            Use Camera
          </button>
          <button
            onclick="document.getElementById('leaf_image').click()"
            class="bg-green-300 text-green-900 px-4 py-2 rounded-lg"
          >
            Upload Image
          </button>
        </div>
      </div>
    </div>
    <script>
      let stream;
      let video = document.getElementById("cameraPreview");
      let realtimeInterval;
      let cropSelector = document.getElementById("crop_type");
      const predictionBox = document.createElement("div");
      let predictionOverlay = document.getElementById("predictionOverlay");
      let predictionText = document.getElementById("predictionText");
      let spinner = document.getElementById("spinner");

      function startRealtimePrediction() {
        clearInterval(realtimeInterval);
        const canvas = document.createElement("canvas");
        predictionOverlay.classList.remove("hidden");
        spinner.classList.remove("hidden");
        predictionText.innerText = "Loading...";

        realtimeInterval = setInterval(() => {
          if (!cropSelector.value) {
            predictionText.innerText = "Select a crop type";
            spinner.classList.add("hidden");
            predictionOverlay.className = baseOverlayClass + " bg-white";
            return;
          }

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext("2d").drawImage(video, 0, 0);

          canvas.toBlob((blob) => {
            const formData = new FormData();
            formData.append("frame", blob);
            formData.append("crop_type", cropSelector.value);

            spinner.classList.remove(
              "text-green-800",
              "text-yellow-800",
              "text-red-800"
            );
            spinner.classList.add("text-green-800");
            spinner.classList.remove("hidden");
            predictionText.innerText = "Scanning...";

            fetch("/api/predict-frame/", {
              method: "POST",
              body: formData,
            })
              .then((res) => res.json())
              .then((data) => {
                spinner.classList.add("hidden");

                if (data.error) {
                  predictionText.innerText = "Prediction error";
                  updateOverlayColor("error");
                } else {
                  predictionText.innerText = `${data.disease} (${data.confidence}%)`;
                  updateOverlayColor(data.confidence);
                }
              })
              .catch(() => {
                spinner.classList.add("hidden");
                predictionText.innerText = "Server error";
                updateOverlayColor("error");
              });
          }, "image/jpeg");
        }, 1500);
      }

      function stopRealtimePrediction() {
        clearInterval(realtimeInterval);
        predictionOverlay.classList.add("hidden");
        predictionText.innerText = "";
        spinner.classList.add("hidden");
      }

      // Open the camera modal
      async function openCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;

          // Reset overlay UI
          predictionText.innerText = "Loading...";
          spinner.classList.remove("hidden");
          predictionOverlay.classList.remove("hidden");
          predictionOverlay.className =
            baseOverlayClass + " bg-white bg-opacity-80 text-green-800";

          document.getElementById("cameraModal").classList.remove("hidden");
          document.getElementById("imageModal").classList.add("hidden"); // Hide the imageModal when camera is opened
          startRealtimePrediction();
        } catch (err) {
          alert("Camera access denied or not available.");
        }
      }

      // Close the camera modal
      function closeCamera() {
        if (stream) stream.getTracks().forEach((track) => track.stop());
        stopRealtimePrediction();
        document.getElementById("cameraModal").classList.add("hidden");
      }

      // Capture the photo and update the image preview
      function capturePhoto() {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        canvas.toBlob((blob) => {
          const file = new File([blob], "captured.jpg", { type: "image/jpeg" });
          const dt = new DataTransfer();
          dt.items.add(file);
          document.getElementById("leaf_image").files = dt.files;
          handleFile(file);
          closeCamera();
          document.getElementById("imageModal").classList.add("hidden"); // Close the imageModal after file is captured
        }, "image/jpeg");
      }

      // Handle the file input (display the image preview)
      function handleFile(file) {
        if (!file || !file.type.startsWith("image/")) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("preview").src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      // Function to close the modal
      function closeModal(event) {
        if (event) {
          // Close the modal if clicked outside the modal content
          event.preventDefault();
        }
        document.getElementById("imageModal").classList.add("hidden");
      }

      // Close the modal when clicking outside the modal content
      document
        .getElementById("imageModal")
        .addEventListener("click", function (event) {
          if (event.target === this) {
            closeModal(event); // Close when clicking outside modal
          }
        });

      // Handle the form submission
      document
        .querySelector("form")
        .addEventListener("submit", function (event) {
          const leafImage = document.getElementById("leaf_image").files[0];
          if (!leafImage) {
            event.preventDefault(); // Prevent form submission
            document.getElementById("imageModal").classList.remove("hidden"); // Show the modal
          }
        });

      // When a user selects a file (upload), close the modal
      document
        .getElementById("leaf_image")
        .addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            handleFile(file); // Show preview
            document.getElementById("imageModal").classList.add("hidden"); // Close the modal
          }
        });

      const baseOverlayClass =
        "absolute bottom-2 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg text-sm font-semibold shadow flex items-center space-x-2";

      function updateOverlayColor(confidence) {
        let bgClass = "";
        let textColor = "";

        if (typeof confidence === "string" && confidence === "error") {
          bgClass = "bg-red-100";
          textColor = "text-red-800";
        } else if (confidence < 60) {
          bgClass = "bg-red-100";
          textColor = "text-red-800";
        } else if (confidence >= 60 && confidence <= 85) {
          bgClass = "bg-yellow-100";
          textColor = "text-yellow-800";
        } else {
          bgClass = "bg-green-100";
          textColor = "text-green-800";
        }

        predictionOverlay.className = `${baseOverlayClass} ${bgClass} ${textColor}`;
        spinner.classList.remove(
          "text-green-800",
          "text-yellow-800",
          "text-red-800"
        );

        if (textColor.includes("green"))
          spinner.classList.add("text-green-800");
        if (textColor.includes("yellow"))
          spinner.classList.add("text-yellow-800");
        if (textColor.includes("red")) spinner.classList.add("text-red-800");
      }
    </script>
  </body>
</html>
